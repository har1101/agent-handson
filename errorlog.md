# 3_mcp_agent.pyå®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼

æ‰‹é †é€šã‚Šã«å®Ÿè£…ã—ãŸå ´åˆã‚‚ã€ã¿ã®ã‚‹ã‚“ã•ã‚“ã®GitHubã‹ã‚‰ã‚³ãƒ”ãƒšã—ãŸå ´åˆã‚‚ã€åŒã˜403ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸã€‚
GitHub Codespacesã‹ã‚‰ã®Knowledge MCPã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ã‹ã‚‚â€¦ï¼Ÿ

```terminal
$ python 3_mcp_agent.py 

unhandled exception during asyncio.run() shutdown
task: <Task finished name='Task-2' coro=<load_mcp_tools() done, defined at /usr/local/python/3.12.1/lib/python3.12/site-packages/langchain_mcp_adapters/tools.py:144> exception=UnboundLocalError("cannot access local variable 'tools' where it is not associated with a value")>
  + Exception Group Traceback (most recent call last):
  |   File "/usr/local/python/3.12.1/lib/python3.12/asyncio/runners.py", line 194, in run
  |     return runner.run(main)
  |            ^^^^^^^^^^^^^^^^

(ç•¥)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/usr/local/python/3.12.1/lib/python3.12/site-packages/mcp/client/streamable_http.py", line 405, in handle_request_async
    |     await self._handle_post_request(ctx)
    |   File "/usr/local/python/3.12.1/lib/python3.12/site-packages/mcp/client/streamable_http.py", line 277, in _handle_post_request
    |     response.raise_for_status()
    |   File "/home/codespace/.local/lib/python3.12/site-packages/httpx/_models.py", line 829, in raise_for_status
    |     raise HTTPStatusError(message, request=request, response=self)
    | httpx.HTTPStatusError: Client error '403 Forbidden' for url 'https://knowledge-mcp.global.api.aws'
    | For more information check: https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/python/3.12.1/lib/python3.12/site-packages/langchain_mcp_adapters/tools.py", line 175, in load_mcp_tools
    convert_mcp_tool_to_langchain_tool(session, tool, connection=connection) for tool in tools
                                                                                         ^^^^^
UnboundLocalError: cannot access local variable 'tools' where it is not associated with a value
  + Exception Group Traceback (most recent call last):
  |   File "/workspaces/agent-handson/chapter4/3_mcp_agent.py", line 97, in <module>
  |     asyncio.run(main())
  |   File "/usr/local/python/3.12.1/lib/python3.12/asyncio/runners.py", line 194, in run
  |     return runner.run(main)
  |            ^^^^^^^^^^^^^^^^

(ç•¥)
```

## mcp-remoteã‚’ä½¿ã†æ–¹æ³•ã¸åˆ‡ã‚Šæ›¿ãˆã‚‹

å°‘ã—å®Ÿè£…ã‚’å¤‰ãˆã¦ã€[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ãŸmcp-remoteã‚’ä½¿ã†æ–¹æ³•ã¸åˆ‡ã‚Šæ›¿ãˆ](https://github.com/awslabs/mcp/tree/main/src/aws-knowledge-mcp-server)ã¾ã—ãŸãŒã€æ¥ç¶šã¯ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
ã‚¨ãƒ©ãƒ¼å†…å®¹ãŒå°‘ã—è©³ç´°ã«ãªã‚Šã€CloudFrontã«ã‚ˆã‚‹403ã‚¨ãƒ©ãƒ¼ã ã£ãŸã®ã§ã€Knowledge MCPå´ã®WAFã«å¼•ã£ã‹ã‹ã£ã¦ã„ã‚‹ã®ã‹ã‚‚â€¦ã¨æ€ã„ã¾ã—ãŸ(æœ¬å½“ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã¯ç¢ºèªã§ãã¦ã„ã¾ã›ã‚“ãŒâ€¦)ã€‚

```terminal
$ python 3_mcp_agent.py 

[83990] Using automatically selected callback port: 46565 idealTree:#root Completed in 102ms
[83990] [83990] Connecting to remote server: https://knowledge-mcp.global.api.aws
[83990] Using transport strategy: http-first
[83990] Connection error: Error: Error POSTing to endpoint (HTTP 403): <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>403 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Request blocked.
We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
<BR clear="all">
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
<BR clear="all">
<HR noshade size="1px">
<PRE>
Generated by cloudfront (CloudFront)
Request ID: SuUxBkLcPGTcydAHkBeu-wZfXsXe6V3GhsoHgRlisyO2kgKgDSx0rg==
</PRE>
<ADDRESS>
</ADDRESS>
</BODY></HTML>
    at StreamableHTTPClientTransport.send (file:///home/codespace/.npm/_npx/705d23756ff7dacc/node_modules/mcp-remote/dist/chunk-OXNXVROF.js:13266:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
[83990] Fatal error: Error: Error POSTing to endpoint (HTTP 403): <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML><HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<TITLE>ERROR: The request could not be satisfied</TITLE>
</HEAD><BODY>
<H1>403 ERROR</H1>
<H2>The request could not be satisfied.</H2>
<HR noshade size="1px">
Request blocked.
We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.
<BR clear="all">
If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.
<BR clear="all">
<HR noshade size="1px">
<PRE>
Generated by cloudfront (CloudFront)
Request ID: SuUxBkLcPGTcydAHkBeu-wZfXsXe6V3GhsoHgRlisyO2kgKgDSx0rg==
</PRE>
<ADDRESS>
</ADDRESS>
</BODY></HTML>
    at StreamableHTTPClientTransport.send (file:///home/codespace/.npm/_npx/705d23756ff7dacc/node_modules/mcp-remote/dist/chunk-OXNXVROF.js:13266:15)
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
unhandled exception during asyncio.run() shutdown
task: <Task finished name='Task-2' coro=<load_mcp_tools() done, defined at /usr/local/python/3.12.1/lib/python3.12/site-packages/langchain_mcp_adapters/tools.py:144> exception=UnboundLocalError("cannot access local variable 'tools' where it is not associated with a value")>
  + Exception Group Traceback (most recent call last):
  |   File "/usr/local/python/3.12.1/lib/python3.12/asyncio/runners.py", line 194, in run
  |     return runner.run(main)
  |            ^^^^^^^^^^^^^^^^

(ç•¥)
```

## @modelcontextprotocol/inspectorã§ã®æ¥ç¶šç¢ºèª

ãƒ–ãƒ©ã‚¦ã‚¶ã¯é–‹ã„ãŸã‚‚ã®ã®ã€MCPã‚µãƒ¼ãƒãƒ¼ã¸æ¥ç¶šã§ããšã€‚

```terminal
$ npx @modelcontextprotocol/inspector https://knowledge-mcp.global.api.aws
Need to install the following packages:
@modelcontextprotocol/inspector@0.16.2
Ok to proceed? (y) y
Starting MCP inspector...
âš™ï¸ Proxy server listening on localhost:6277
ğŸ”‘ Session token: **************************************
   Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable auth

ğŸš€ MCP Inspector is up and running at:
   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=**************************************

ğŸŒ Opening browser...
```

![alt text](mcp_inspector_failed.png)

## æ¯”è¼ƒï¼šãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ã‹ã™

åŸå› åˆ‡ã‚Šåˆ†ã‘ã®ä¸€ç’°ã¨ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã‚‚åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã€å‹•ã‹ã—ã¦ã¿ã¾ã—ãŸã€‚
ã“ã¡ã‚‰ã ã¨å•é¡Œãªãå‹•ä½œã—ã¾ã—ãŸã€‚
```terminal
(agent-handson) chapter4 $  uv run 3_mcp_agent.py 

Secure MCP Filesystem Server running on stdio
Client does not support MCP Roots, using allowed directories set from server args: [
  '/project/path/agent-handson/chapter4'
]
Secure MCP Filesystem Server running on stdio
Client does not support MCP Roots, using allowed directories set from server args: [
  '/project/path/agent-handson/chapter4'
]
{'messages': [HumanMessage(content='Bedrockã§åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ãƒ¼ã‚’æ•™ãˆã¦ï¼', additional_kwargs={}, response_metadata={}), AIMessage(content=[{'type': 'text', 'text': 'AWS Bedrockã§åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã¤ã„ã¦ã®æƒ…å ±ã‚’æ¤œç´¢ã—ã¦ã€Markdownå½¢å¼ã§ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¾ã™ã€‚\n\nã¾ãšã¯AWS Bedrockã«é–¢ã™ã‚‹æƒ…å ±ã‚’æ¤œç´¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚'}, {'type': 'tool_use', 'name': 'aws___search_documentation', 'input': {'search_phrase': 'AWS Bedrock available model providers', 'limit': 10}, 
(ç•¥)
```

[å®Ÿè¡Œçµæœãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã¡ã‚‰(chapter4/aws_bedrock_model_providers.md)](chapter4/aws_bedrock_model_providers.md)


### VSCodeã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§@modelcontextprotocol/inspectorã‚’å®Ÿè¡Œ

ã“ã¡ã‚‰ã‚‚å•é¡Œãªãæ¥ç¶šã§ãã€ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¾ã§ã§ãã¾ã—ãŸã€‚

![alt text](mcp_inspector_success.png)

